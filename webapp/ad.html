<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>AnÃºncio</title>
  <link rel="stylesheet" href="/webapp/style.css?v=5"/>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="t1">Assistir anÃºncio</div>
          <div class="t2">Abre no navegador â€¢ Volte apÃ³s o tempo</div>
        </div>
      </div>
      <div id="statusBar" class="status" data-type="warn">Pronto</div>
    </header>

    <main class="content">
      <section class="panel active">
        <div class="card">
          <div class="title">Tempo mÃ­nimo</div>
          <div class="muted">VocÃª precisa ficar fora por:</div>
          <div class="big" id="need">â€”</div>
          <button class="btn" id="openBtn">ðŸ”“ Abrir anÃºncio</button>
          <div class="muted" style="margin-top:10px">
            Depois volte para o Telegram. O game contabiliza automaticamente.
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const tg_id = params.get("tg_id") || "";
    const nonce = params.get("nonce") || "";
    const min = Math.max(10, Number(params.get("min") || 20));

    document.getElementById("need").textContent = `${min}s`;

    const LINKS = [
      "https://www.effectivegatecpm.com/uxsrj9n2h?key=48b82410e36175baaf64291fbcb2f0ce"
    ];
    const pick = ()=>LINKS[Math.floor(Math.random()*LINKS.length)];

    function openExternal(url){
      try{
        if (window.Telegram?.WebApp?.openLink){
          Telegram.WebApp.openLink(url, { try_instant_view:false });
          return;
        }
      } catch {}
      window.open(url,"_blank");
    }

    async function postOpened(){
      const r = await fetch("/api/ad/opened", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ tg_id, nonce })
      }).then(x=>x.json()).catch(()=>({ok:false,error:"network"}));
      return r;
    }

    document.getElementById("openBtn").onclick = async ()=>{
      document.getElementById("statusBar").textContent = "Iniciandoâ€¦";
      const opened = await postOpened();
      if (!opened.ok){
        document.getElementById("statusBar").textContent = "Falhou";
        alert("Erro: "+(opened.error||"erro"));
        return;
      }

      localStorage.setItem("ad_pending", JSON.stringify({
        tg_id, nonce, min,
        openedAt: Date.now()
      }));

      document.getElementById("statusBar").textContent = "Aberto âœ…";
      openExternal(pick());
    };
  </script>
</body>
</html>
